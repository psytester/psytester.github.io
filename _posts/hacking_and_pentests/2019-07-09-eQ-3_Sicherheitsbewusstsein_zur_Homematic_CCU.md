---
layout: post
title:  "(kein) echtes Sicherheitsbewusstsein von eQ-3 zu Homematic CCU Sicherheitslücken?"
date:   2019-08-08 23:00:00 MEST
author: 'psytester'
---

Ob eQ-3 als Hersteller der Homematic CCU das Thema Sicherheit wirklich ernst nimmt oder nur pressewirksam in einer Eigendarstellung darüber berichtet, wie zuletzt am 18.03.2019 die [eQ-3 Pressemitteilung](https://www.eq-3.de/aktuelles/newsreader/eq-3-schliesst-sicherheitsluecken-in-der-ccu.html) aka [CVE-2019-10119](https://nvd.nist.gov/vuln/detail/CVE-2019-10119) [CVE-2019-10120](https://nvd.nist.gov/vuln/detail/CVE-2019-10120) [CVE-2019-10121](https://nvd.nist.gov/vuln/detail/CVE-2019-10121) [CVE-2019-10122](https://nvd.nist.gov/vuln/detail/CVE-2019-10122), ich weiß es nicht.<br>
Ich als Melder von potentiellen Sicherheitslücken fühle mich jedenfalls zum Ende hin nicht ernst genommen.<br>
Auch die bisher schon bekannten 6 CVEs aus dem Jahr 2018, davon 3 schwere Sicherheitslücken, siehe Übersicht auf [www.cvedetails.com](https://www.cvedetails.com/vulnerability-list/vendor_id-17729/Eq-3.html), sind teilweise heute noch nicht behoben worden oder erst "frisch" nach einem Jahr.<br>
Leider teils nur oberflächlich geflickt....

# Chronologie der Kommunikation mit eQ-3

In Summe hatte ich anfänglich 16 Punkte an eQ-3 gemeldet.
Die ersten am 29.01.2019, der Rest verteilt bis zum 08.05.2019.

Am 19.03. habe ich zum aktuellen Stand der bisherigen Funde nachgefragt.

Am 19.03. habe ich auch an die BSI CERTBUND E-Mailadresse alle bisherigen Punkte und die passenden Exploits geschickt, mit der Hoffnung das es dann mehr Gewichtung beim Hersteller bekommt. eQ-3 hatte ja selber von einer "engen Zusammenarbeit mit dem BSI" geschrieben.<br>
Am 05.04. vom BSI final die Info erhalten, das auch ich eine Antwort von eQ-3 bis zum 08.04. erhalten soll.<br>
Am 08.04. wurde ich vom BSI gefragt, ob ich denn wie erwartet von eQ-3 kontaktiert wurde.<br>
Am 11.04. über das BSI noch mal nachgehakt, der 08. war ja ereignislos verstrichen.

Am 11.04. Abends von eQ-3 eine erste Antwort erhalten.<br>
Am 27.04. von eQ-3 einen "streng vertraulichen" Releaseplan erhalten, mit der Info dass dies eher eine große Ausnahme ist und der Hersteller eher kein Feedback gibt.<br>

Am 16.05. warnte das BSI über den CertBund Twitter Account [Mehrere tausend HomeMatic SmartHome-Systeme in Deutschland sind offen aus dem Internet erreichbar](https://www.twitter.com/certbund/status/1128955705451581440).<br>
Die Zahlen decken sich mit dem was ich über die Wochen hinweg kommuniziert habe.<br>
Dank meines [Vorschlags]( https://github.com/jens-maus/RaspberryMatic/pull/597) die einfache Erkennung der Systeme zu verschleiern, indem der HTTP Header "Server:" abgeschaltet wird, sind Homematic Systeme mit aktueller 2.47.10/3.47.10 und RaspberryMatic Firmeware nicht mehr so leicht auffindbar.
Am 16.07. listet [shodan](https://www.shodan.io/search?query=%22ise+GmbH+HTTP-Server+v2.0%22) 5388 offene Systeme und [censys](https://censys.io/ipv4?q=%22ise+GmbH+HTTP-Server+v2.0%22) nur 1576. Es waren mal weit über 8000 bei shodan.<br>
Am 25.06. wurden die Releases CCU3 3.47.10 und CCU2 2.47.10 veröffentlicht (für die CCU2 somit sogar 2 Wochen früher als geplant).

# Ende Gut, alles Gut?

Nein, leider nicht. Ein erstes Antesten hat gezeigt, das teilweise noch die selben Sicherheitslücken vorhanden sind und nun auch mindestens eine neue hinzugekommen ist ;-).<br>
Ich bereite nun die Veröffentlichung der bisherigen CVEs vor und zeige auf, wie man die Schwachstellen auch teilweise sehr gut kombinieren kann.<br>
Dem Hersteller werde ich die neue Schwachstelle melden und die unvollständig gefixte aufzeigen. Ich hoffe weiterhin, das es positiv und vor allem professioneller weitergehen wird.<br>
Wenn ich schon als Hobby Pentester das hinbekomme, weil die CCU ein gutes Übungsobjekt ist, um eine Schwachstelle mit einer anderen zu verbinden, was macht dann der professionelle digitale Einbrecher mit diesem Wissen?<br>

Am 15.07. habe ich meine Zusammenfassung für die mittlerweile 17 Punkte an eQ-3 und dem BSI verschickt.<br>
Und die Reise ging noch weiter...

# Weitere Chronologie der Kommunikation mit eQ-3
Ab dem 24.07. habe ich die CVEs nach und nach veröffentlicht<br>
<br>
Am 01.08. eQ-3 nochmalig kontaktiert, weil keinerlei Reaktion kam und dabei auch neue Schwachstellen gemeldet<br>
Am 05.08. hat mich das BSI gefragt, wie der Stand der Dinge ist, da die CVEs gesichtet wurden<br>
Am 16.08. hat das BSI bei eQ-3 ein weiteres mal nachgehakt<br>
Am 21.08. hat eQ-3 eine kurze Entschuldigungs E-Mail geschrieben mit der Aussicht einer neuen finalen Stellungnahme<br>
Am 26.08. kam die neue Stellungnahme und ein neuer Zeitplan<br>
Am 17.09. wurden die Releases CCU3 3.47.18 und CCU2 2.47.18 veröffentlicht und diese beheben die schlimmsten Punkte aus der Liste.<br>
<br>
Jetzt kann ich es ja verraten. Es hätte einen November Release geben sollen mit den nun vorliegenden Korrekturen, aber interessanterweise wurden diese ReGa Korrekturen allesamt vom Opensource RaspberryMatic Entwickler gefixt und auch meine Anregung das Accesslevel in der system.fn und programs.fn zu checken hat er umgesetzt, wodurch der Punkt 19 aka CVE-2019-14473 entschärft wurde.
Diese Arbeit hätte ich eindeutig von eQ-3 erwartet, aber sei's drum.

# Und Jetzt? Ende Gut, alles Gut?

Hmm...<br>
Der neue Zeitplan hat noch ein paar Punkte offen, wir werden also sehen. Ich kenne die angestrebten Zeiträume und teste dann nach.<br>
Aus Software Sicht wird sich also hoffentlich alles erledigen.<br>
<br>
Aber um es Spannend zu belassen, da kommt noch was ganz anderes.<br>
Bis dahin, abwarten....<br>

## Die Liste der gemeldeten Punkte

Punkt|Tag der Meldung| Problem | CCU2/CCU3? | Resultat bei einem Angriff | Ergebnis oder Lösung am 08.08. | Ergebnis oder Lösung am 17.09.
---|---|---|---|---|---|---
1|29.01.2019  |veralteter lighttpd Webserver | nur CCU2 | Denial of Service | Leider noch kein Update. Mittlerweile als [CVE-2019-9582](https://psytester.github.io/CVE-2019-9582/) veröffentlicht | N.A.
2|29.01.2019 |veraltetes Oracle Java 8u121 | nur CCU2 | noch kein konkretes | mit Release 2.47.10 Update auf letztes freies Oracle Java 8u201. Nach dem Update ist vor dem Update, somit wieder veraltet | N.A.
3|29.01.2019 | stark veraltetes Embedded Linux Build Root und BusyBox | nur CCU2 | noch kein konkretes | Teil der mittlerweile als [CVE-2019-9582](https://psytester.github.io/CVE-2019-9582/) veröffentlichen Schwachstelle | N.A.
4|13.02.2019| Keine generelle Login SessionID Absicherung von CGI und HTML Seiten | beide | * Denial of Service<br>* Uncontrolled Resource Consumption<br>* File Modification / Deletion | * eQ-3 ist nicht für die AddOns verantwortlich, liefert jedoch den Unterbau und der enthält derzeit noch eine veraltete Node.js Version<br>* eQ-3 eigene Seiten bleiben ungeschützt<br>Ist es eine CCU2 oder CCU3? http://myip/upnp/basic_dev.cgi<br>Installierte Firmware abfragen für weitere Angriffe: http://myip/api/backup/version.cgi<br>* Mediola NEO Server v2.4.5 ist nur teilweise gelöst, alle Details als [CVE-2019-13030](https://psytester.github.io/CVE-2019-13030/) veröffentlicht<br>* Cloudmatic noch nicht in der Firmware, jedoch schon vom AddOn Hersteller seit Ende Mai mit einem Hotfix vorbereitet, siehe [Github Issue #8](https://github.com/EasySmartHome/CloudMatic-CCUAddon/issues/8), Details als [CVE-2019-9584](https://psytester.github.io/CVE-2019-9584/) veröffentlicht | N.A.
5|28.02.2019 | ReGaHss nicht dokumentierter interner Befehl system.Exec() | beide | Remote Code Execution | Keine befriedigende Lösung. Bei Recherchen im Nachgang sogar schon seit Feb. 2018 bekannt als [CVE-2018-7297](https://atomic111.github.io/article/homematic-ccu2-remote-code-execution) veröffentlichte Schwachstelle | N.A.
6|28.02.2019 | Aufruf der /index.htm Seite erzeugt SessionID | beide | Denial of Service | Gelöst mit Release 2.41.8 und 3.43.15.<br>Wurde schon vorher durch anderen Pentester gefunden und unter den CVEs [CVE-2019-10119](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-10119), [CVE-2019-10120](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-10120) und [CVE-2019-10121](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-10121) veröffentlicht. Wurde am 18.03. Pressewirksam ausgerollt | schon gefixt
7|28.02.2019 | Process Fuzzing auf die URI /xml-api | beide | noch kein konkretes | soll eventuell in kommenden Versionen behoben werden | N.A.
8|13.03.2019 | JSON API User.getUserPWD ohne gültige SessionID | beide | Passwort Hash auslesen | Wurde parallel schon von anderem Pentester gefunden und als [CVE-2019-9727](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-9727) veröffentlicht.<br>Mit Release 2.41.9 und 3.43.16 nur vom LEVEL NONE auf LEVEL USER gehoben und somit konnte zumindest ein Account mit Level User das Admin Passwort weiterhin auslesen.<br>Erst seit Release 2.47.10 / 3.47.10 wurde User.getUserPWD durch User.hasUserPWD ersetzt und somit final gefixt. | schon gefixt
9|12.04.2019 | expliziter Hinweis auf schon bekannte CVEs | beide | * Directory Traversal<br>* Arbitrary File Write<br>* Remote Code Execution | Alte Lücken wie [CVE-2018-7297](https://www.cvedetails.com/cve/CVE-2018-7297/) und auch neue Lücken wie [CVE-2019-9726](https://www.cvedetails.com/cve/CVE-2019-9726/) sind weiterhin nicht gefixt | [CVE-2019-9726](https://www.cvedetails.com/cve/CVE-2019-9726/) ist mit 2.47.18 & 3.47.18 gefixt
10|12.04.2019 | JSON API Interface.getMetadata / Interface.setMetadata und Interface.removeMetadata ohne gültige SessionID | beide | Meta Daten auslesen, (korrupt) verändern, löschen | Seit Release 2.47.10 und 3.47.10 gefixed. Als [CVE-2019-9585](https://psytester.github.io/CVE-2019-9585/) veröffentlicht | schon gefixt
11|07.05.2019 | Erzeugung einer SessionID ohne gültigen Login | beide | * Escalation of Privileges<br>* Denial of Service<br>* Information Disclosure  | Mit Release 2.47.10 und 3.47.10 nur für wenige Seitenaufrufe gefixed, der große Rest ist noch angreifbar. Als [CVE-2019-9583](https://psytester.github.io/CVE-2019-9583/) veröffentlicht | mit 2.47.18 & 3.47.18 gefixt
12|07.05.2019 | Ohne gültigen Login kann man die Systemprotokoll Einträge löschen | beide | * Escalation of Privileges | Noch ungelöst. Als Teilpunkt des [CVE-2019-14475](https://psytester.github.io/CVE-2019-14475/) veröffentlicht | mit 2.47.18 & 3.47.18 gefixt
13|07.05.2019 | Ohne gültigen Login kann man die Servicemeldungen lesen | beide | * Escalation of Privileges | Noch ungelöst. Als Teilpunkt des [CVE-2019-14475](https://psytester.github.io/CVE-2019-14475/) veröffentlicht | mit 2.47.18 & 3.47.18 gefixt
14|07.05.2019 | Ohne gültigen Login kann man User teilweise einrichten | beide | * Escalation of Privileges | Noch ungelöst. Als Teilpunkt des [CVE-2019-14475](https://psytester.github.io/CVE-2019-14475/) veröffentlicht | mit 2.47.18 & 3.47.18 gefixt
15|08.05.2019 | Prozess Fuzzing im ReGaHss Process für Call() ExecEnum() Methoden | beide | noch kein konkretes | zumindest im Logfile entstehen Einträge wegen fehlerhafter Aufrufe | N.A.
16|08.05.2019 | ReGaHss Prozess Absturz bei einem POST Request mit einem leeren Call("") | nur CCU3 | Denial of Service | Noch ungelöst. Als [CVE-2019-14474](https://psytester.github.io/CVE-2019-14474/) veröffentlicht | mit 2.47.18 & 3.47.18 gefixt
17|15.07.2019 | Keine Session Invalidierung/Löschung beim Abmleden im Release 2.47.10/12 und 3.47.10 | beide | mit CVE-2019-9726 die SessionID auslesen und WebUI betreten | Ich habe keine Lust dafür einen CVE zu erstellen, zumal die Lücke mit dem Release 2.47.15 und 3.47.15 sogar schon wieder gefixt wurde | mit 2.47.18 & 3.47.18 gefixt
18|01.08.2019 | Ohne gültigen Login kann man interne HM Scripte/Programme deaktivieren, manipulieren und löschen | beide | * Escalation of Privileges | Noch ungelöst. Als Teilpunkt des [CVE-2019-14475](https://psytester.github.io/CVE-2019-14475/) veröffentlicht | mit 2.47.18 & 3.47.18 gefixt
19|01.08.2019 | Das Rechte Konzept der CCU besitzt keine echte Mandantenfähigkeit. Ein Gast und User Account kann viele Admin Operationen durchführen | beide | mit CVE-2019-9726 die SessionID auslesen und WebUI betreten | Noch ungelöst. Als [CVE-2019-14473](https://psytester.github.io/CVE-2019-14473/) veröffentlicht | mit 2.47.18 & 3.47.18 gefixt
20|26.08.2019 | Neue Variante einer Remote Code Execution bei bestimmten HTTP POST Requests | beide | Remote Code Execution | ----- | Als [CVE-2019-16199](https://psytester.github.io/CVE-2019-16199/) veröffentlicht, gefixt mit 2.47.18 & 3.47.18


# Disclaimer

The information provided is released "as is" without warranty of any kind. The publisher disclaims all warranties, either express or implied, including all warranties of merchantability. No responsibility is taken for the correctness of this information.
In no event shall the publisher be liable for any damages whatsoever including direct, indirect, incidental, consequential, loss of business profits or special damages, even if the publisher has been advised of the possibility of such damages.

The contents of this advisory are copyright (c) 2019 by psytester and may be distributed freely provided that no fee is charged for this distribution and proper credit is given.
